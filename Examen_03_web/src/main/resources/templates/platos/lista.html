<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{fragments/header :: header}"></head>
<body>
<div th:replace="~{fragments/navbar :: navbar}"></div>
<div class="d-flex">
    <div th:replace="~{fragments/sidebar :: sidebar}"></div>
    <div class="main-content flex-grow-1 p-4">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/dashboard">Dashboard</a></li>
                <li class="breadcrumb-item active">Platos</li>
            </ol>
        </nav>
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h2 class="mb-1"><i class="fas fa-pizza-slice me-2"></i>Gestión de Platos</h2>
                <p class="text-muted mb-0">Administra el menú del restaurante</p>
            </div>
            <div>
                <button class="btn btn-primary-custom" onclick="location.href='/platos/crear'"
                        sec:authorize="hasRole('ADMIN')">
                    <i class="fas fa-plus me-2"></i>Nuevo Plato
                </button>
            </div>
        </div>
        <div class="row mb-4">
            <div class="col-md-3 mb-3">
                <div class="card border-left-primary">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="text-muted small mb-1">Total Platos</div>
                                <div class="h4 mb-0" th:text="${totalPlatos}">0</div>
                            </div>
                            <div class="text-primary">
                                <i class="fas fa-utensils fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-left-success">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="text-muted small mb-1">Disponibles</div>
                                <div class="h4 mb-0" th:text="${platosDisponibles}">0</div>
                            </div>
                            <div class="text-success">
                                <i class="fas fa-check-circle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-left-warning">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="text-muted small mb-1">Stock Bajo</div>
                                <div class="h4 mb-0" th:text="${platosStockBajo}">0</div>
                            </div>
                            <div class="text-warning">
                                <i class="fas fa-exclamation-triangle fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3 mb-3">
                <div class="card border-left-info">
                    <div class="card-body">
                        <div class="d-flex justify-content-between">
                            <div>
                                <div class="text-muted small mb-1">Precio Promedio</div>
                                <div class="h4 mb-0">
                                    S/ <span th:text="${#numbers.formatDecimal(precioPromedio, 1, 2)}">0.00</span>
                                </div>
                            </div>
                            <div class="text-info">
                                <i class="fas fa-dollar-sign fa-2x"></i>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="card mb-4">
            <div class="card-body">
                <form id="filterForm" class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">Tipo de Plato</label>
                        <select class="form-select" name="tipo" id="tipoFilter" onchange="aplicarFiltros()">
                            <option value="">Todos</option>
                            <option value="ENTRADA">Entrada</option>
                            <option value="PLATO_PRINCIPAL">Plato Principal</option>
                            <option value="POSTRE">Postre</option>
                            <option value="BEBIDA">Bebida</option>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Precio Máximo</label>
                        <input type="number" class="form-control" name="precioMax"
                               id="precioMaxFilter" placeholder="S/ 0.00" step="0.01" min="0"
                               oninput="aplicarFiltros()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Buscar</label>
                        <input type="text" class="form-control" id="searchInput"
                               placeholder="Nombre del plato..." oninput="aplicarFiltros()">
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">&nbsp;</label>
                        <button type="button" class="btn btn-secondary w-100" onclick="limpiarFiltros()">
                            <i class="fas fa-eraser me-2"></i>Limpiar
                        </button>
                    </div>
                </form>
            </div>
        </div>
        <div class="mb-3">
            <div class="btn-group" role="group">
                <button type="button" class="btn btn-outline-primary active" onclick="cambiarVista('grid')">
                    <i class="fas fa-th-large"></i> Tarjetas
                </button>
                <button type="button" class="btn btn-outline-primary" onclick="cambiarVista('table')">
                    <i class="fas fa-table"></i> Tabla
                </button>
            </div>
        </div>
        <div id="gridView" class="row">
            <div class="col-md-6 col-lg-4 mb-4 plato-item"
                 th:each="plato : ${platos}"
                 th:attr="data-tipo=${plato.tipo.name()}, data-precio=${plato.precio}, data-nombre=${plato.nombre}">
                <div class="card plato-card h-100">
                    <div class="plato-image-container">
                        <img th:if="${plato.imagenUrl}"
                             th:src="${plato.imagenUrl}"
                             class="card-img-top"
                             th:alt="${plato.nombre}">
                        <div th:unless="${plato.imagenUrl}" class="plato-image-placeholder">
                            <i class="fas fa-utensils fa-4x text-muted"></i>
                        </div>
                        <span class="badge position-absolute top-0 end-0 m-2"
                              th:classappend="${plato.tipo.name() == 'ENTRADA' ? 'bg-info' : plato.tipo.name() == 'PLATO_PRINCIPAL' ? 'bg-primary' : plato.tipo.name() == 'POSTRE' ? 'bg-warning text-dark' : 'bg-success'}"
                              th:text="${plato.tipo.name()}">
                            TIPO
                        </span>
                    </div>
                    <div class="card-body">
                        <h5 class="card-title" th:text="${plato.nombre}">Nombre del Plato</h5>
                        <p class="card-text text-muted small text-truncate-2" th:text="${plato.descripcion}">
                            Descripción del plato
                        </p>
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <span class="h4 mb-0 text-primary">
                                S/ <span th:text="${#numbers.formatDecimal(plato.precio, 1, 2)}">0.00</span>
                            </span>
                            <span class="badge"
                                  th:classappend="${plato.disponible} ? 'bg-success' : 'bg-danger'"
                                  th:text="${plato.disponible} ? 'Disponible' : 'No Disponible'">
                                Estado
                            </span>
                        </div>
                        <div class="plato-info">
                            <small class="text-muted">
                                <i class="fas fa-clock me-1"></i>
                                <span th:text="${plato.tiempoPreparacion} + ' min'">15 min</span>
                            </small>
                            <small class="text-muted ms-3" th:if="${plato.calorias}">
                                <i class="fas fa-fire me-1"></i>
                                <span th:text="${plato.calorias} + ' kcal'">250 kcal</span>
                            </small>
                        </div>
                    </div>
                    <div class="card-footer bg-white border-top-0">
                        <div class="d-grid gap-2">
                            <a th:href="@{/platos/{id}(id=${plato.id})}" class="btn btn-sm btn-primary">
                                <i class="fas fa-eye me-1"></i>Ver Detalles
                            </a>
                            <div class="btn-group" role="group" sec:authorize="hasRole('ADMIN')">
                                <a th:href="@{/platos/{id}/editar(id=${plato.id})}"
                                   class="btn btn-sm btn-secondary">
                                    <i class="fas fa-edit"></i> Editar
                                </a>
                                <button type="button" class="btn btn-sm btn-warning"
                                        th:onclick="'toggleDisponibilidad(' + ${plato.id} + ')'">
                                    <i class="fas fa-toggle-on"></i>
                                </button>
                                <button type="button" class="btn btn-sm btn-danger"
                                        th:onclick="'eliminarPlato(' + ${plato.id} + ')'">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div id="tableView" class="card" style="display: none;">
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover" id="platosTable">
                        <thead>
                        <tr>
                            <th>Imagen</th>
                            <th>Nombre</th>
                            <th>Tipo</th>
                            <th>Precio</th>
                            <th>Tiempo</th>
                            <th>Estado</th>
                            <th>Acciones</th>
                        </tr>
                        </thead>
                        <tbody>
                        <tr th:each="plato : ${platos}">
                            <td>
                                <img th:if="${plato.imagenUrl}"
                                     th:src="${plato.imagenUrl}"
                                     class="img-thumbnail"
                                     style="width: 50px; height: 50px; object-fit: cover;"
                                     th:alt="${plato.nombre}">
                                <div th:unless="${plato.imagenUrl}"
                                     class="bg-light d-flex align-items-center justify-content-center"
                                     style="width: 50px; height: 50px;">
                                    <i class="fas fa-utensils text-muted"></i>
                                </div>
                            </td>
                            <td>
                                <strong th:text="${plato.nombre}">Nombre</strong><br>
                                <small class="text-muted" th:text="${plato.descripcion}">Descripción</small>
                            </td>
                            <td>
                                <span class="badge"
                                      th:classappend="${plato.tipo.name() == 'ENTRADA' ? 'bg-info' : plato.tipo.name() == 'PLATO_PRINCIPAL' ? 'bg-primary' : plato.tipo.name() == 'POSTRE' ? 'bg-warning text-dark' : 'bg-success'}"
                                      th:text="${plato.tipo.name()}">
                                    TIPO
                                </span>
                            </td>
                            <td>
                                <strong>S/ <span th:text="${#numbers.formatDecimal(plato.precio, 1, 2)}">0.00</span></strong>
                            </td>
                            <td>
                                <i class="fas fa-clock me-1"></i>
                                <span th:text="${plato.tiempoPreparacion} + ' min'">15 min</span>
                            </td>
                            <td>
                                <span class="badge"
                                      th:classappend="${plato.disponible} ? 'bg-success' : 'bg-danger'"
                                      th:text="${plato.disponible} ? 'Disponible' : 'No Disponible'">
                                    Estado
                                </span>
                            </td>
                            <td>
                                <div class="btn-group btn-group-sm" role="group">
                                    <a th:href="@{/platos/{id}(id=${plato.id})}"
                                       class="btn btn-primary" title="Ver detalles">
                                        <i class="fas fa-eye"></i>
                                    </a>
                                    <a th:href="@{/platos/{id}/editar(id=${plato.id})}"
                                       class="btn btn-secondary" title="Editar"
                                       sec:authorize="hasRole('ADMIN')">
                                        <i class="fas fa-edit"></i>
                                    </a>
                                    <button type="button" class="btn btn-warning"
                                            th:onclick="'toggleDisponibilidad(' + ${plato.id} + ')'"
                                            title="Cambiar disponibilidad"
                                            sec:authorize="hasRole('ADMIN')">
                                        <i class="fas fa-toggle-on"></i>
                                    </button>
                                    <button type="button" class="btn btn-danger"
                                            th:onclick="'eliminarPlato(' + ${plato.id} + ')'"
                                            title="Eliminar"
                                            sec:authorize="hasRole('ADMIN')">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="alert alert-info text-center" th:if="${#lists.isEmpty(platos)}">
            <i class="fas fa-info-circle fa-2x mb-3"></i>
            <h5>No hay platos registrados</h5>
            <p class="mb-3">Comienza creando tu primer plato</p>
            <a href="/platos/crear" class="btn btn-primary-custom" sec:authorize="hasRole('ADMIN')">
                <i class="fas fa-plus me-2"></i>Crear Plato
            </a>
        </div>
    </div>
</div>
<div th:replace="~{fragments/footer :: footer}"></div>
<script src="https://code.jquery.com/jquery-3.7.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script>
    function cambiarVista(vista) {
        const gridView = document.getElementById('gridView');
        const tableView = document.getElementById('tableView');
        const buttons = document.querySelectorAll('.btn-group button');
        if (vista === 'grid') {
            gridView.style.display = 'flex';
            tableView.style.display = 'none';
            buttons[0].classList.add('active');
            buttons[1].classList.remove('active');
        } else {
            gridView.style.display = 'none';
            tableView.style.display = 'block';
            buttons[0].classList.remove('active');
            buttons[1].classList.add('active');
            if (!$.fn.DataTable.isDataTable('#platosTable')) {
                $('#platosTable').DataTable({
                    language: { url: '//cdn.datatables.net/plug-ins/1.13.4/i18n/es-ES.json' },
                    pageLength: 10
                });
            }
        }
    }
    function aplicarFiltros() {
        const tipo = document.getElementById('tipoFilter').value;
        const precioMax = document.getElementById('precioMaxFilter').value;
        const busqueda = document.getElementById('searchInput').value.toLowerCase();
        const items = document.querySelectorAll('.plato-item');
        items.forEach(item => {
            const itemTipo = item.getAttribute('data-tipo');
            const itemPrecio = parseFloat(item.getAttribute('data-precio'));
            const itemNombre = item.getAttribute('data-nombre').toLowerCase();
            let mostrar = true;
            if (tipo && itemTipo !== tipo) { mostrar = false; }
            if (precioMax && itemPrecio > parseFloat(precioMax)) { mostrar = false; }
            if (busqueda && !itemNombre.includes(busqueda)) { mostrar = false; }
            item.style.display = mostrar ? 'block' : 'none';
        });
    }
    function limpiarFiltros() {
        document.getElementById('filterForm').reset();
        document.getElementById('searchInput').value = '';
        aplicarFiltros();
    }
    function toggleDisponibilidad(platoId) {
        Swal.fire({
            title: '¿Cambiar disponibilidad?',
            text: 'El plato cambiará su estado de disponibilidad',
            icon: 'question',
            showCancelButton: true,
            confirmButtonColor: '#ff6b35',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, cambiar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/platos/${platoId}/disponibilidad`, { method: 'PUT' })
                    .then(response => {
                        if (response.ok) {
                            Swal.fire('¡Actualizado!', 'La disponibilidad ha cambiado', 'success').then(() => location.reload());
                        } else { Swal.fire('Error', 'No se pudo cambiar la disponibilidad', 'error'); }
                    })
                    .catch(error => { Swal.fire('Error', 'Ocurrió un error: ' + error.message, 'error'); });
            }
        });
    }
    function eliminarPlato(platoId) {
        Swal.fire({
            title: '¿Eliminar plato?',
            text: 'Esta acción no se puede deshacer',
            icon: 'warning',
            showCancelButton: true,
            confirmButtonColor: '#dc3545',
            cancelButtonColor: '#6c757d',
            confirmButtonText: 'Sí, eliminar',
            cancelButtonText: 'Cancelar'
        }).then((result) => {
            if (result.isConfirmed) {
                fetch(`/platos/${platoId}`, { method: 'DELETE' })
                    .then(response => {
                        if (response.ok) {
                            Swal.fire('¡Eliminado!', 'El plato ha sido eliminado', 'success').then(() => location.reload());
                        } else {
                            return response.json().then(data => { throw new Error(data.message || 'Error al eliminar'); });
                        }
                    })
                    .catch(error => { Swal.fire('Error', error.message, 'error'); });
            }
        });
    }
</script>
</body>
</html>